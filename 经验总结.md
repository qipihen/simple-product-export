# 经验总结（simple-product-export）

## 一、这次遇到的核心问题

1. 最小化导入不稳定（只保留少量字段回导时经常“无效”）
2. 分类导入后表现不一致（字段更新了但前台/SEO表现异常）
3. 导入性能不稳定（大文件容易慢、卡、超时）
4. 后台分类字段选择页面首屏偏慢（taxonomy 多时明显）
5. 插件通用性不足（带有业务站点特有字段，影响跨站复用）

## 二、根因拆解（第一性原理）

1. **CSV 契约不稳定**
   - 导入依赖固定列或隐含列顺序时，最小化 CSV 容易失效。
   - 表头大小写、BOM、别名不统一，导致列索引匹配失败。

2. **导入副作用过大**
   - 分类每次导入都刷新 rewrite 规则，成本高且不总是必要。
   - SEO 同步存在跨插件写入，增加冗余和不可预期行为。

3. **处理模型不合理**
   - 先整表读内存再处理对大 CSV 不友好。
   - 日志过细会放大 I/O，影响导入吞吐。

4. **UI 数据获取路径不必要地昂贵**
   - 页面加载时预查全部 taxonomy 字段，不是核心必要路径。

5. **项目结构含历史包袱**
   - 多个历史压缩包、旧备份文件和临时目录留在项目中，增加维护噪音。

## 三、已落地的修复与优化

1. **分类字段改为按需加载（P3）**
   - 首屏只加载当前 taxonomy。
   - 切换 taxonomy 时异步拉取字段并缓存。

2. **导入流程稳定化**
   - 分类导入改为流式逐行处理。
   - 日志策略改为“异常行 + 汇总”。

3. **副作用控制**
   - 仅在 slug 真正变化时刷新 rewrite。
   - SEO 同步按“当前激活插件”写入，避免跨插件污染。

4. **通用化改造**
   - 取消硬编码业务字段，改为 filter 扩展。
   - 支持最小化字段回导，ID 作为稳定主键。

5. **仓库清理（本次）**
   - 清理了历史压缩包、旧备份源码、项目内临时 skills 目录。
   - 保留当前有效源码、文档、测试与标准安装包。

## 四、后续可复用的工程原则

1. **导入插件先定义“CSV 契约”，再写逻辑**
2. **导入只做必要写入，不做隐式重任务**
3. **所有“全量预加载”都要问：是否是首屏必需**
4. **日志默认面向排障，不面向逐行审计**
5. **通用插件不携带业务私货，用扩展点承载差异**
6. **每次发布前做目录清理，防止历史文件进入交付物**

## 五、建议的发布前检查清单

1. `php -l simple-product-export.php`
2. `php tests/regression_csv_contract.php`
3. 验证最小化导入（仅 ID + 目标字段）
4. 验证 taxonomy 切换时字段异步加载正常
5. 验证 SEO 在 AIOSEO / RankMath / Yoast 中仅写当前激活插件
6. 只打包必要文件：源码、README、docs、tests（按交付策略）
