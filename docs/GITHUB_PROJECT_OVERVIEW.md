# simple-product-export 项目说明（GitHub）

> 面向多站点/多客户可复用的 WordPress 内容导入导出插件。

## 1. 项目定位

`simple-product-export` 是一个单文件 WordPress 插件，目标是用同一套工具覆盖不同客户站点的内容批量维护场景：

- 导出站点现有内容为 CSV，作为“真值模板”
- 在表格里批量修改
- 再导入回站点，按 `ID` / `term_id` 精准更新

插件优先保证“可回导、低副作用、跨站点可复用”，而不是绑定某个特定业务字段。

## 2. 功能总览

### 2.1 支持对象

- 产品（WooCommerce `product`）
- 页面（`page`）
- 文章（`post`）
- 分类与自定义分类法（所有 public taxonomy）

### 2.2 导出能力

- CSV UTF-8 导出（含 BOM，兼容 Excel 打开）
- 产品/文章支持分类和关键词筛选
- 分类导出支持“字段级选择”
- 自动识别并导出自定义字段（排除内部保留键）
- 附件字段自动补充 `*_url` 辅助列，便于人工校对

### 2.3 导入能力

- 按主键更新：`ID`（文章/页面/产品）与 `ID/term_id`（分类）
- 基础字段 + SEO 字段 + 自定义字段统一导入
- ACF 优先写入（可回退 `update_post_meta` / `update_term_meta`）
- 分类导入支持最小化列集（保留需要改的字段即可）

## 3. 关键设计（稳定性）

### 3.1 最小化导入兼容

- 分类导出字段可选，不强制全字段回导
- 导入端通过表头匹配（大小写和 BOM 归一）而不是固定列序
- 只更新 CSV 中出现且有值的列，降低误覆盖风险

### 3.2 流式处理

- 分类导入按行流式处理，不先整表载入内存
- 大文件场景下降低内存峰值与超时概率

### 3.3 日志策略

- 调试日志以异常行与关键状态为主（无效 ID / 未找到 / 更新失败）
- 最后输出统一汇总（总行数、更新数、无变化、错误数）

### 3.4 SEO 同步策略（低副作用）

- 运行时检测当前激活 SEO 插件
- 仅同步到当前激活提供方：
  - AIOSEO
  - Rank Math
  - Yoast
- 未检测到 SEO 插件时跳过 SEO 写入并记录提示

### 3.5 分类字段加载性能

- 后台页面不再预加载全部 taxonomy 字段映射
- 首屏仅加载当前分类法字段
- 切换分类法时通过 AJAX 按需加载

### 3.6 Slug 与重写规则

- 仅在分类 slug 实际发生变化时刷新 rewrite 规则
- 避免每次导入都触发高成本 `flush_rewrite_rules()`

## 4. 通用化原则（可用于不同客户站）

- 不内置业务私有字段白名单
- 分类“保留字段”通过 filter 扩展：`spe_required_taxonomy_custom_fields`
- 默认行为依赖站点真实数据动态生成字段，不污染无关站点 UI

## 5. 推荐操作流程

1. 从目标站点先导出一份最新 CSV（作为模板）
2. 只修改需要变更的值，尽量不改表头
3. 仅保留需要变更的字段列（最小化导入）
4. 上传 UTF-8 `.csv` 文本（不要上传 `.xlsx`）
5. 导入后查看异常行与汇总日志

## 6. CSV 契约与故障排查

- CSV 契约：`docs/CSV_CONTRACT.md`
- 常见失败矩阵：`docs/FAILURE_MATRIX.md`
- 版本说明：`docs/RELEASE_NOTES_v4.7.6.md`

## 7. 安装与验证

### 7.1 安装

1. 将 `simple-product-export.php` 放到：
   `wp-content/plugins/simple-product-export/`
2. 在后台启用插件
3. 进入左侧菜单“导入导出工具”

### 7.2 本地验证命令

```bash
php -l simple-product-export.php
php tests/regression_csv_contract.php
```

## 8. 非目标范围（YAGNI）

以下能力不作为插件核心目标，默认不内置：

- 业务专属字段模板硬编码
- 多 SEO 插件同时强制写入
- 导入时全量逐行详细 debug（大文件性能成本过高）

如需这些能力，建议通过 filter 或站点层二次扩展，而非污染通用核心。
